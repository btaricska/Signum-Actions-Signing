name: Sign files with Signum Agent (native PKCS#11)

on:
  workflow_dispatch:
    inputs:
      signum_agent_image:
        description: "Signum agent container image with tag"
        required: false
        default: "keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1"
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      DEFAULT_SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      DOCKER_CONFIG: ${{ github.workspace }}/.docker
      FILES_DIR: filestosign
      PKCS11_LIB: /usr/lib/libkeyfactorpkcs11.so

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Preflight: check required secrets
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
          JFROG_DOCKER_AUTH: ${{ secrets.JFROG_DOCKER_AUTH }}
        run: |
          set -euo pipefail
          for s in SIGNUM_HOSTNAME SIGNUM_CLIENTID SIGNUM_USERNAME SIGNUM_PASSWORD SIGNUM_PKCS11_PIN JFROG_DOCKER_AUTH; do
            if [ -z "${!s:-}" ]; then
              echo "❌ Missing secret: $s"
              exit 1
            fi
          done
          echo "✅ All required secrets present."

      - name: Configure Docker auth
        shell: bash
        env:
          JFROG_DOCKER_AUTH: ${{ secrets.JFROG_DOCKER_AUTH }}
        run: |
          mkdir -p "$DOCKER_CONFIG"
          cat > "$DOCKER_CONFIG/config.json" <<EOF
          {
            "auths": {
              "keyfactor.jfrog.io": {
                "auth": "${JFROG_DOCKER_AUTH}"
              }
            }
          }
          EOF
          chmod 600 "$DOCKER_CONFIG/config.json"
          cp "$DOCKER_CONFIG/config.json" "$HOME/.docker/config.json"
          chmod 600 "$HOME/.docker/config.json"

      - name: Resolve agent image
        id: img
        shell: bash
        run: |
          IMG="${{ inputs.signum_agent_image }}"
          if [ -z "$IMG" ]; then
            IMG="${DEFAULT_SIGNUM_AGENT_IMAGE}"
          fi
          echo "image=$IMG" >> "$GITHUB_OUTPUT"
          echo "Using agent image: $IMG"

      - name: Start Signum agent container
        shell: bash
        env:
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
        run: |
          mkdir -p "$FILES_DIR"
          if [ ! -f "$FILES_DIR/example.txt" ]; then
            echo "Hello from Signum signing demo" > "$FILES_DIR/example.txt"
          fi

          docker rm -f signum-agent >/dev/null 2>&1 || true
          docker run -d --name signum-agent \
            -v "$PWD/$FILES_DIR:/mnt/filestosign" \
            -e SIGNUM_HOSTNAME \
            -e SIGNUM_CLIENTID \
            -e SIGNUM_USERNAME \
            -e SIGNUM_PASSWORD \
            -e SIGNUM_LOGLEVEL=HIGH \
            -e SIGNUM_LOGTYPE=FILE \
            "${SIGNUM_AGENT_IMAGE}"

          echo "Signum agent container started"
          docker ps | grep signum-agent

      - name: List PKCS#11 slots
        shell: bash
        run: |
          echo "=== PKCS#11 slots inside Signum agent ==="
          docker exec signum-agent pkcs11-tool --module /usr/lib/libkeyfactorpkcs11.so --list-slots

      - name: List certificates
        shell: bash
        env:
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          echo "=== Certificates in PKCS#11 ==="
          docker exec signum-agent pkcs11-tool \
            --module /usr/lib/libkeyfactorpkcs11.so \
            --login --pin "${SIGNUM_PKCS11_PIN}" \
            --list-objects --type cert

      - name: List private keys
        shell: bash
        env:
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          echo "=== Private keys in PKCS#11 ==="
          docker exec signum-agent pkcs11-tool \
            --module /usr/lib/libkeyfactorpkcs11.so \
            --login --pin "${SIGNUM_PKCS11_PIN}" \
            --list-objects --type privkey

      - name: Sign files
        shell: bash
        env:
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          for f in /mnt/filestosign/*; do
            outfile="${f}.sig"
            echo "Signing $f -> $outfile"
            docker exec signum-agent pkcs11-tool \
              --module /usr/lib/libkeyfactorpkcs11.so \
              --login --pin "${SIGNUM_PKCS11_PIN}" \
              --sign --input-file "$f" --output-file "$outfile"
          done

      - name: Fetch logs and output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-output
          path: |
            filestosign/**
