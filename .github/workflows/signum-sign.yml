name: Sign with Signum Linux Agent (cosign + PKCS11) on Windows runner

on:
  workflow_dispatch:
    inputs:
      signum_linux_agent_image:
        description: "OCI image to use (repo/path:tag)"
        required: false
        default: "keyfactor.jfrog.io/signum-con-dev/keyfactor/signum-linux-agent:3.72.2-cosign"
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: windows-latest
    env:
      SIGNUM_REGISTRY: keyfactor.jfrog.io
      DEFAULT_SIGNUM_LINUX_AGENT_IMAGE: keyfactor.jfrog.io/signum-con-dev/keyfactor/signum-linux-agent:3.72.2-cosign

      PKCS11_WORK_DIR: pkcs11-work
      PKCS11_WORK_MODULE: pkcs11-work/signum-pkcs11.so
      PKCS11_MOUNT_PATH: /pkcs11/signum-pkcs11.so

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login (JFrog)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.SIGNUM_REGISTRY }}
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_TOKEN }}
          logout: true

      - name: Resolve agent image
        id: img
        shell: pwsh
        run: |
          $img = '${{ inputs.signum_linux_agent_image }}'
          if ([string]::IsNullOrWhiteSpace($img)) { $img = $env:DEFAULT_SIGNUM_LINUX_AGENT_IMAGE }
          "image=$img" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "Using image: $img"

      - name: Prepare PKCS11 module (required)
        shell: pwsh
        env:
          SIGNUM_PKCS11_MODULE_B64: ${{ secrets.SIGNUM_PKCS11_MODULE_B64 }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:SIGNUM_PKCS11_MODULE_B64)) {
            throw "SIGNUM_PKCS11_MODULE_B64 secret is missing (base64 of the PKCS#11 .so)."
          }
          New-Item -ItemType Directory -Force -Path $env:PKCS11_WORK_DIR | Out-Null
          $bytes = [Convert]::FromBase64String($env:SIGNUM_PKCS11_MODULE_B64)
          [System.IO.File]::WriteAllBytes($env:PKCS11_WORK_MODULE, $bytes)
          $fi = Get-Item $env:PKCS11_WORK_MODULE
          "PKCS11 module written: $($fi.FullName) ($($fi.Length) bytes)"

      - name: Start Signum Linux Agent (container)
        shell: pwsh
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
        run: |
          # Convert Windows path to Docker-friendly /c/... style for bind mounts
          $moduleWin = (Resolve-Path $env:PKCS11_WORK_MODULE).Path
          $moduleDocker = ($moduleWin -replace '\\','/')
          if ($moduleDocker -match '^([A-Za-z]):/(.*)$') {
            $moduleDocker = "/$($matches[1].ToLower())/$($matches[2])"
          }

          docker pull $env:SIGNUM_AGENT_IMAGE
          docker rm -f signum-agent *> $null 2>&1

          docker run --name signum-agent -d `
            -e SIGNUM_HOSTNAME `
            -e SIGNUM_CLIENTID `
            -e SIGNUM_USERNAME `
            -e SIGNUM_PASSWORD `
            -e SIGNUM_LOGLEVEL=HIGH `
            -e SIGNUM_LOGTYPE=FILE `
            -v "$moduleDocker`:$($env:PKCS11_MOUNT_PATH):ro" `
            $env:SIGNUM_AGENT_IMAGE

          docker ps -a --no-trunc | Select-Object -First 25
          Start-Sleep -Seconds 3

      - name: PKCS11 token + key discovery (cosign pkcs11-tool)
        shell: pwsh
        env:
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          if (Test-Path "pkcs11-discovery.txt") { Remove-Item "pkcs11-discovery.txt" -Force }

          "== Tokens ==" | Out-File -FilePath "pkcs11-discovery.txt" -Append -Encoding utf8
          docker exec signum-agent cosign pkcs11-tool list-tokens --module "$env:PKCS11_MOUNT_PATH" 2>&1 |
            Tee-Object -FilePath "pkcs11-discovery.txt" -Append

          "" | Out-File -FilePath "pkcs11-discovery.txt" -Append -Encoding utf8
          "== Key URIs ==" | Out-File -FilePath "pkcs11-discovery.txt" -Append -Encoding utf8
          # If PIN is required to enumerate keys, cosign uses the token with the module; PIN handling varies by provider.
          # If your provider requires login for listing keys, keep SIGNUM_PKCS11_PIN set and put it in the URI or provider config.
          docker exec signum-agent cosign pkcs11-tool list-keys-uris --module "$env:PKCS11_MOUNT_PATH" 2>&1 |
            Tee-Object -FilePath "pkcs11-discovery.txt" -Append

      - name: Sign blobs in filestosign/ using cosign + PKCS11
        shell: pwsh
        env:
          # Store the selected key URI as a secret, e.g.:
          # pkcs11:token=...;object=...;type=private
          COSIGN_PKCS11_KEY_URI: ${{ secrets.COSIGN_PKCS11_KEY_URI }}
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:COSIGN_PKCS11_KEY_URI)) {
            throw "Missing COSIGN_PKCS11_KEY_URI secret. Use pkcs11-discovery.txt output to choose one."
          }

          $files = Get-ChildItem -Path "filestosign" -Recurse -File
          if (-not $files -or $files.Count -eq 0) {
            "No files found under filestosign/." | Tee-Object -FilePath signing.log
            exit 0
          }

          foreach ($f in $files) {
            $inContainer = "/work/$($f.FullName -replace '\\','/' )"
            $sigOut = "$inContainer.sig"
            $crtOut = "$inContainer.crt"

            "Signing: $($f.FullName)" | Tee-Object -FilePath signing.log -Append

            # Run cosign inside the container with the repo mounted at /work
            docker exec -e COSIGN_PKCS11_MODULE_PATH="$env:PKCS11_MOUNT_PATH" `
                        -e SIGNUM_PKCS11_PIN="$env:SIGNUM_PKCS11_PIN" `
                        signum-agent `
                        sh -lc "cosign sign-blob --key '$env:COSIGN_PKCS11_KEY_URI' --output-signature '$sigOut' --output-certificate '$crtOut' '$inContainer'" 2>&1 |
              Tee-Object -FilePath signing.log -Append
          }

      - name: Collect agent logs
        if: always()
        shell: pwsh
        run: |
          docker logs signum-agent | Select-Object -Last 300 | Tee-Object -FilePath signum-agent.log

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          docker rm -f signum-agent *> $null 2>&1

      - name: Upload output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-output
          if-no-files-found: ignore
          path: |
            pkcs11-discovery.txt
            signing.log
            signum-agent.log
            filestosign/**
            pkcs11-work/**
