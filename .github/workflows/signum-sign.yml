$ErrorActionPreference = "Stop"
Set-StrictMode -Version Latest

$codeSigningOid = "1.3.6.1.5.5.7.3.3"

$data = Get-ChildItem -Path Cert:\CurrentUser\My |
  Where-Object {
    $_.EnhancedKeyUsageList -and
    ($_.EnhancedKeyUsageList | ForEach-Object { $_.ObjectId.Value }) -contains $codeSigningOid
  } |
  ForEach-Object {
    [PSCustomObject]@{
      CN         = (($_.Subject -split ',\s*' | Select-Object -First 1) -replace '^CN=','')
      Thumbprint = $_.Thumbprint
      NotAfter   = $_.NotAfter
      HasKey     = $_.HasPrivateKey
      Subject    = $_.Subject
      StorePath  = "Cert:\CurrentUser\My"
    }
  } |
  Sort-Object -Property `
    @{ Expression = "HasKey";   Descending = $true }, `
    @{ Expression = "NotAfter"; Descending = $true }

$data | ConvertTo-Json -Depth 100 | Out-File -FilePath "cert_data.json" -Encoding utf8
Write-Host "=== cert_data.json ==="
Get-Content .\cert_data.json | Write-Host

if (-not $data -or $data.Count -eq 0) {
  throw "No Code Signing certs found in Cert:\CurrentUser\My"
}

$chosen = $data | Where-Object { $_.HasKey } | Select-Object -First 1
if (-not $chosen) { $chosen = $data | Select-Object -First 1 }

"SIGNING_THUMBPRINT=$($chosen.Thumbprint)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
Write-Host "Chosen thumbprint: $($chosen.Thumbprint)"
Write-Host "Chosen CN: $($chosen.CN)"
Write-Host "HasPrivateKey: $($chosen.HasKey)"
Write-Host "Chosen expires: $($chosen.NotAfter)"
