name: Signum PKCS#11 File Signing

on:
  push:
    paths:
      - 'filestosign/**'

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      FILES_DIR: filestosign
      PKCS11_LIB: /usr/lib/libkeyfactorpkcs11.so
      CONTAINER_NAME: signum-agent

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify required secrets
        run: |
          set -euo pipefail
          for s in SIGNUM_HOSTNAME SIGNUM_CLIENTID SIGNUM_USERNAME SIGNUM_PASSWORD SIGNUM_PKCS11_PIN; do
            if [ -z "${!s:-}" ]; then
              echo "❌ Missing secret: $s"
              exit 1
            fi
          done
          echo "✅ All required secrets present."
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail

      - name: Start Signum agent container
        run: |
          docker rm -f $CONTAINER_NAME || true
          docker run -d --name $CONTAINER_NAME \
            -v $PWD/$FILES_DIR:/mnt/$FILES_DIR \
            -e SIGNUM_HOSTNAME="${{ secrets.SIGNUM_HOSTNAME }}" \
            -e SIGNUM_CLIENTID="${{ secrets.SIGNUM_CLIENTID }}" \
            -e SIGNUM_USERNAME="${{ secrets.SIGNUM_USERNAME }}" \
            -e SIGNUM_PASSWORD="${{ secrets.SIGNUM_PASSWORD }}" \
            $SIGNUM_AGENT_IMAGE tail -f /dev/null
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail

      - name: Wait for container to initialize
        run: sleep 10

      - name: List PKCS#11 slots
        run: docker exec $CONTAINER_NAME pkcs11-tool --module $PKCS11_LIB --list-slots
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail

      - name: List certificates
        run: docker exec $CONTAINER_NAME pkcs11-tool \
          --module $PKCS11_LIB \
          --login --pin "${{ secrets.SIGNUM_PKCS11_PIN }}" \
          --list-objects --type cert
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail

      - name: List private keys
        run: docker exec $CONTAINER_NAME pkcs11-tool \
          --module $PKCS11_LIB \
          --login --pin "${{ secrets.SIGNUM_PKCS11_PIN }}" \
          --list-objects --type privkey
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail

      - name: Sign files
        run: |
          for f in $FILES_DIR/*; do
            echo "Signing $f..."
            docker exec $CONTAINER_NAME pkcs11-tool \
              --module $PKCS11_LIB \
              --login --pin "${{ secrets.SIGNUM_PKCS11_PIN }}" \
              --sign \
              --input-file "/mnt/$FILES_DIR/$(basename $f)" \
              --output-file "/mnt/$FILES_DIR/$(basename $f).sig"
          done
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail
