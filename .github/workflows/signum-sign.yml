name: Sign JSON Demo EXE

on:
  workflow_dispatch:

jobs:
  sign:
    runs-on: windows-latest

    steps:

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build Demo EXE
        shell: pwsh
        run: |
          dotnet new console -n DemoApp --framework net8.0

          $jsonContent = '${{ secrets.JSON_TO_SIGN }}'

          Set-Content -Path .\DemoApp\Program.cs -Value @"
          using System;
          class Program
          {
              static void Main()
              {
                  Console.WriteLine(@\"$jsonContent\");
              }
          }
          "@

          dotnet publish .\DemoApp -c Release -r win-x64 --self-contained false -f net8.0 -o .\out

      - name: Download Signum Agent
        shell: pwsh
        run: |
          curl -L -o kf-agent.msi "https://kfsaas0167ead7.blob.core.windows.net/signum-public/agents/windows/4.40.1/kf-agent-x64-4.40.1-ffb85044-MS-WO_Trust.msi"

      - name: Install Signum Agent
        shell: pwsh
        run: |
          msiexec /i kf-agent.msi /passive `
            RTPRIMARY="${{ secrets.SIGNUM_HOSTNAME }}" `
            RTSECONDARY="${{ secrets.SIGNUM_HOSTNAME }}" `
            CLIENTID="${{ secrets.SIGNUM_CLIENTID }}" `
            AuthMode="LocalUsers" `
            AGENTMODE="SERVER" `
            Language="en-US"

      - name: Configure Agent Authentication
        shell: pwsh
        run: |
          & "C:\Program Files\KeyFactor\rtsetup.exe" `
            -authMode=LocalUsers `
            -username="${{ secrets.SIGNUM_USERNAME }}" `
            -password="${{ secrets.SIGNUM_PASSWORD }}"

      - name: Restart RTService
        shell: pwsh
        run: |
          Restart-Service RTService
          Start-Sleep -Seconds 5

      - name: Sign EXE
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64\signtool.exe" sign /fd sha256 /tr http://timestamp.sectigo.com /td sha256 /sm /n "Demo" ".\out\DemoApp.exe"

      - name: Verify Signature
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.26100.0\x64\signtool.exe" verify /pa ".\out\DemoApp.exe"

      - name: Upload Signed EXE
        uses: actions/upload-artifact@v4
        with:
          name: signed-demo-exe
          path: ".\out\DemoApp.exe"
