name: Sign JSON with Signum PKCS11

on:
  workflow_dispatch:

jobs:
  sign:
    runs-on: ubuntu-latest

    env:
      SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      FILES_DIR: filestosign
      CONTAINER_NAME: signum-agent

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ============================================================
      # CREATE TEMPORARY JSON FILE TO SIGN
      # ============================================================
      - name: Create JSON file to sign
        shell: bash
        run: |
          set -e
          TMP_DIR="$RUNNER_TEMP/$FILES_DIR"
          mkdir -p "$TMP_DIR"
          echo '{"message":"Hello from Signum + PKCS11 demo"}' > "$TMP_DIR/file.json"
          echo "‚úÖ JSON file created"

      # ============================================================
      # START SIGNUM AGENT CONTAINER
      # ============================================================
      - name: Start Signum agent container
        shell: bash
        run: |
          set -e
          docker run -d --name $CONTAINER_NAME \
            -e SIGNUM_USERNAME=${{ secrets.SIGNUM_USERNAME }} \
            -e SIGNUM_PASSWORD=${{ secrets.SIGNUM_PASSWORD }} \
            -v "$RUNNER_TEMP/$FILES_DIR":/mnt/$FILES_DIR \
            $SIGNUM_AGENT_IMAGE
          echo "‚úÖ Signum agent started"

      # ============================================================
      # SIGN FILE USING PKCS11
      # ============================================================
      - name: Sign JSON file using PKCS11
        shell: bash
        run: |
          set -euo pipefail

          MODULE="/usr/lib/libkeyfactorpkcs11.so"
          CONTAINER_FILE="/mnt/$FILES_DIR/file.json"
          CONTAINER_SIG="/mnt/$FILES_DIR/file.json.sig"

          echo "üîé Verifying input file exists inside container..."
          docker exec $CONTAINER_NAME test -f "$CONTAINER_FILE" || {
            echo "‚ùå Input file not found"
            exit 1
          }
          echo "‚úÖ Input file verified"

          echo "üîç Detecting first available slot..."
          SLOT=$(docker exec $CONTAINER_NAME pkcs11-tool \
            --module "$MODULE" \
            --list-slots \
            | awk '/^Slot/ {print $2; exit}')

          if [ -z "${SLOT:-}" ]; then
            echo "‚ùå No PKCS11 slots found"
            exit 1
          fi
          echo "‚úÖ Using slot: $SLOT"

          echo "üîë Extracting first private key..."
          KEY_ID=$(docker exec $CONTAINER_NAME pkcs11-tool \
            --module "$MODULE" \
            --slot "$SLOT" \
            --login \
            --list-objects --type privkey \
            | awk '/ID:/ {print $2; exit}')

          if [ -z "${KEY_ID:-}" ]; then
            echo "‚ùå No private key found in slot $SLOT"
            exit 1
          fi
          echo "‚úÖ Using private key ID: $KEY_ID"

          echo "‚úçÔ∏è Signing file..."
          docker exec $CONTAINER_NAME pkcs11-tool \
            --module "$MODULE" \
            --slot "$SLOT" \
            --login \
            --sign \
            --input-file "$CONTAINER_FILE" \
            --output-file "$CONTAINER_SIG" \
            --id "$KEY_ID"

          echo "üì¶ Verifying signature file..."
          docker exec $CONTAINER_NAME test -f "$CONTAINER_SIG" || {
            echo "‚ùå Signature file not created"
            exit 1
          }

          echo "üì• Copying signature back to runner..."
          cp "$RUNNER_TEMP/$FILES_DIR/file.json.sig" .

          echo "‚úÖ Signing completed successfully"

      # ============================================================
      # UPLOAD SIGNATURE ARTIFACT (v4)
      # ============================================================
      - name: Upload signature artifact
        uses: actions/upload-artifact@v4
        with:
          name: signed-json
          path: file.json.sig

      # ============================================================
      # CLEANUP
      # ============================================================
      - name: Stop container
        if: always()
        run: |
          docker rm -f $CONTAINER_NAME || true
