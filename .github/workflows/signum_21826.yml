name: Sign File via Signum Agent + PKCS11

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest

    env:
      SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:latest
      FILES_DIR: filestosign
      CONTAINER_NAME: signum-agent
      DOCKER_CONFIG: ${{ github.workspace }}/.docker

      # PKCS#11 module path inside container
      PKCS11_MODULE: /usr/lib/libkeyfactorpkcs11.so

      # Optional: expected subject fragment to help humans confirm the right cert is present
      EXPECTED_CERT_SUBJECT: "CN=CodeSigningCertificate"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate secrets
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          JFROG_DOCKER_AUTH: ${{ secrets.JFROG_DOCKER_AUTH }}
          USER_PIN: ${{ secrets.USER_PIN }}
        run: |
          set -euo pipefail
          for s in SIGNUM_HOSTNAME SIGNUM_CLIENTID SIGNUM_USERNAME SIGNUM_PASSWORD JFROG_DOCKER_AUTH USER_PIN; do
            if [ -z "${!s:-}" ]; then
              echo "❌ Missing secret: $s"
              exit 1
            fi
          done
          echo "✅ Secrets validated"
          echo "ℹ️ USER_PIN present (length ${#USER_PIN})"

      - name: Configure Docker auth
        shell: bash
        env:
          JFROG_DOCKER_AUTH: ${{ secrets.JFROG_DOCKER_AUTH }}
        run: |
          set -euo pipefail
          mkdir -p "$DOCKER_CONFIG"
          cat > "$DOCKER_CONFIG/config.json" <<EOF
{
  "auths": {
    "keyfactor.jfrog.io": {
      "auth": "$JFROG_DOCKER_AUTH"
    }
  }
}
EOF
          echo "✅ Docker auth configured"
