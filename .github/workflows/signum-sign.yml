      - name: List ALL tokens, certs, and keys (PKCS#11 inventory)
        shell: bash
        env:
          MODULE_PATH: ${{ steps.pkcs11.outputs.module }}
          USER_PIN: ${{ secrets.USER_PIN }}
        run: |
          set -euo pipefail

          echo "========================================"
          echo "PKCS#11 MODULE"
          echo "  $MODULE_PATH"
          echo "========================================"
          ls -la "$MODULE_PATH" || true
          ldd "$MODULE_PATH" || true
          echo

          echo "========================================"
          echo "TOKENS (p11tool - preferred on 22.04+)"
          echo "========================================"
          if command -v p11tool >/dev/null 2>&1; then
            p11tool --list-tokens --provider "$MODULE_PATH" || true
          else
            echo "p11tool not found"
          fi
          echo

          echo "========================================"
          echo "SLOTS (pkcs11-tool)"
          echo "========================================"
          pkcs11-tool --module "$MODULE_PATH" --list-slots --verbose || true
          echo

          # Choose first available slot number if we can
          SLOT="$(pkcs11-tool --module "$MODULE_PATH" --list-slots 2>/dev/null \
            | awk '/^Slot [0-9]+/ {gsub("Slot ",""); gsub(":",""); print $1; exit}' || true)"

          if [ -z "${SLOT:-}" ]; then
            echo "⚠️ Could not parse a slot number; will run listings without --slot."
          else
            echo "✅ Using slot: $SLOT"
          fi
          echo

          echo "========================================"
          echo "CERTIFICATES"
          echo "========================================"
          if [ -n "${SLOT:-}" ]; then
            CERTS="$(pkcs11-tool --module "$MODULE_PATH" --slot "$SLOT" --list-objects --type cert 2>&1 || true)"
          else
            CERTS="$(pkcs11-tool --module "$MODULE_PATH" --list-objects --type cert 2>&1 || true)"
          fi
          echo "$CERTS"
          echo

          echo "---- Parsed certificate summary (Label / Subject / ID) ----"
          # Prints a clean summary per certificate object
          echo "$CERTS" | awk '
            BEGIN{label=""; subj=""; id=""}
            /^Certificate Object/ { if (label||subj||id){print "Label: "label"\nSubject: "subj"\nID: "id"\n---"}; label="";subj="";id=""; next}
            /^[[:space:]]*label:/   {sub(/^[[:space:]]*label:[[:space:]]*/,""); label=$0; next}
            /^[[:space:]]*subject:/ {sub(/^[[:space:]]*subject:[[:space:]]*/,""); subj=$0; next}
            /^[[:space:]]*ID:/      {sub(/^[[:space:]]*ID:[[:space:]]*/,""); id=$0; next}
            END{ if (label||subj||id){print "Label: "label"\nSubject: "subj"\nID: "id"\n---"} }
          ' | sed -n '1,300p'
          echo

          echo "========================================"
          echo "PUBLIC KEYS"
          echo "========================================"
          if [ -n "${SLOT:-}" ]; then
            pkcs11-tool --module "$MODULE_PATH" --slot "$SLOT" --list-objects --type pubkey --verbose || true
          else
            pkcs11-tool --module "$MODULE_PATH" --list-objects --type pubkey --verbose || true
          fi
          echo

          echo "========================================"
          echo "PRIVATE KEYS (requires login)"
          echo "========================================"
          if [ -z "${USER_PIN:-}" ]; then
            echo "⚠️ USER_PIN secret not set; skipping private key listing."
            exit 0
          fi

          # Private keys require login
          if [ -n "${SLOT:-}" ]; then
            pkcs11-tool --module "$MODULE_PATH" --slot "$SLOT" --login --pin "$USER_PIN" --list-objects --type privkey --verbose || true
          else
            pkcs11-tool --module "$MODULE_PATH" --login --pin "$USER_PIN" --list-objects --type privkey --verbose || true
          fi
