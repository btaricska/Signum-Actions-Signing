name: Sign File via Signum Agent + PKCS11

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-22.04

    env:
      JSIGN_DEB_URL: "https://github.com/ebourg/jsign/releases/download/6.0/jsign_6.0_all.deb"
      KF_CFG_PATH: "/etc/keyfactor/config"
      PKCS11_PROVIDER_CFG: "keyfactorpkcs11.cfg"
      OUT_DIR: "signed-output"
      PKCS11_MODULE_DEFAULT: "/usr/lib/libkeyfactorpkcs11.so"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          USER_PIN: ${{ secrets.USER_PIN }}
          KF_AGENT_DEB_URL: ${{ secrets.KF_AGENT_DEB_URL }}
        run: |
          set -euo pipefail
          for s in SIGNUM_HOSTNAME SIGNUM_CLIENTID SIGNUM_USERNAME SIGNUM_PASSWORD USER_PIN KF_AGENT_DEB_URL; do
            if [ -z "${!s:-}" ]; then
              echo "âŒ Missing secret: $s"
              exit 1
            fi
          done
          echo "âœ… Secrets validated"

      - name: Install prerequisites
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            opensc opensc-pkcs11 pcscd libpcsclite1 libccid \
            p11-kit gnutls-bin \
            default-jre-headless \
            mingw-w64 \
            curl ca-certificates

      - name: Create a random EXE to sign (Windows PE)
        shell: bash
        run: |
          set -euo pipefail
          cat > hello.c <<'EOF'
          #include <windows.h>
          #include <stdio.h>
          int main() { printf("Hello from Signum signing demo!\n"); return 0; }
          EOF
          x86_64-w64-mingw32-gcc -O2 -s -o hello-world-app.exe hello.c
          echo "âœ… Created hello-world-app.exe"
          file hello-world-app.exe
          ls -la hello-world-app.exe

      - name: Install jsign (.deb)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o jsign.deb "$JSIGN_DEB_URL"
          sudo dpkg -i jsign.deb || (sudo apt-get install -f -y && sudo dpkg -i jsign.deb)
          jsign --version || true

      - name: Install Keyfactor Agent (.deb) and start service
        shell: bash
        env:
          KF_AGENT_DEB_URL: ${{ secrets.KF_AGENT_DEB_URL }}
        run: |
          set -euo pipefail

          # Trim whitespace/newlines (secrets sometimes have them)
          AGENT_URL="$(printf "%s" "${KF_AGENT_DEB_URL:-}" | tr -d '\r' | xargs)"

          if [ -z "${AGENT_URL:-}" ]; then
            echo "âŒ KF_AGENT_DEB_URL is empty"
            exit 1
          fi
          if ! printf "%s" "$AGENT_URL" | grep -qE '^https?://'; then
            echo "âŒ KF_AGENT_DEB_URL does not look like a URL (no quotes, one line, URL only)."
            echo "â„¹ï¸ Length: ${#AGENT_URL}"
            exit 1
          fi

          echo "â¬‡ï¸ Downloading keyfactor agent .deb..."
          curl -fsSL -o kf-agent.deb "$AGENT_URL"

          echo "ðŸ“¦ Installing keyfactor agent..."
          sudo dpkg -i kf-agent.deb || (sudo apt-get install -f -y && sudo dpkg -i kf-agent.deb)

          echo "ðŸš€ Restarting KeyfactorService..."
          sudo systemctl daemon-reload || true
          sudo systemctl enable KeyfactorService || true
          sudo systemctl restart KeyfactorService

          sudo journalctl -u KeyfactorService -n 80 --no-pager || true
          ss -ltnp || true

      - name: Configure agent (keyfactor-setup)
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
        run: |
          set -euo pipefail
          echo -e "loglevel=HIGH\nlogtype=FILE" | sudo tee "$KF_CFG_PATH" >/dev/null || true

          sudo keyfactor-setup \
            hostname="$SIGNUM_HOSTNAME" \
            clientid="$SIGNUM_CLIENTID" \
            username="$SIGNUM_USERNAME" \
            password="$SIGNUM_PASSWORD" \
            loglevel=HIGH logtype=FILE

          sudo systemctl restart KeyfactorService

      - name: Find PKCS#11 module path
        id: pkcs11
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATES=(
            "$PKCS11_MODULE_DEFAULT"
            /usr/local/keyfactor/pkcs11/libkeyfactorpkcs11.so
            /usr/lib/libkeyfactorpkcs11.so
            /usr/lib/x86_64-linux-gnu/libkeyfactorpkcs11.so
            /usr/lib64/libkeyfactorpkcs11.so
          )

          FOUND=""
          for p in "${CANDIDATES[@]}"; do
            if [ -f "$p" ]; then FOUND="$p"; break; fi
          done

          if [ -z "$FOUND" ]; then
            FOUND="$(sudo find / -type f -name 'libkeyfactorpkcs11.so' 2>/dev/null | head -n 1 || true)"
          fi

          if [ -z "$FOUND" ]; then
            echo "âŒ libkeyfactorpkcs11.so not found"
            exit 1
          fi

          echo "âœ… PKCS#11 module: $FOUND"
          echo "module=$FOUND" >> "$GITHUB_OUTPUT"

      - name: Write SunPKCS11 config
        shell: bash
        env:
          MODULE_PATH: ${{ steps.pkcs11.outputs.module }}
        run: |
          set -euo pipefail
          cat > "$PKCS11_PROVIDER_CFG" <<EOF
          name=KeyfactorPKCS11
          library=${MODULE_PATH}
          description=Keyfactor PKCS#11 interface
          EOF
          cat "$PKCS11_PROVIDER_CFG"

      - name: Choose certificate alias
        id: cert
        shell: bash
        env:
          CERT_ALIAS: ${{ secrets.CERT_ALIAS || '' }}
        run: |
          set -euo pipefail
          if [ -n "${CERT_ALIAS:-}" ]; then
            echo "alias=$CERT_ALIAS" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OUT="$(keytool -list -storetype PKCS11 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg "$PKCS11_PROVIDER_CFG" -storepass NONE 2>/dev/null || true)"
          FIRST_ID="$(echo "$OUT" | grep -oP '^[0-9A-F]+' | head -n 1 || true)"

          if [ -z "${FIRST_ID:-}" ]; then
            echo "âŒ No certificate IDs found via keytool"
            exit 1
          fi

          echo "alias=$FIRST_ID" >> "$GITHUB_OUTPUT"

      - name: Sign with jsign (Authenticode)
        shell: bash
        env:
          CERT_ALIAS: ${{ steps.cert.outputs.alias }}
        run: |
          set -euo pipefail
          mkdir -p "$OUT_DIR"
          cp -f hello-world-app.exe "$OUT_DIR/"

          jsign \
            --storetype PKCS11 \
            --keystore "$PKCS11_PROVIDER_CFG" \
            --storepass NONE \
            --alias "$CERT_ALIAS" \
            "$OUT_DIR/hello-world-app.exe"

          ls -la "$OUT_DIR"

      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: SignedFile-Linux-Agent
          path: signed-output/*
