name: Sign (Linux runner) via Keyfactor Agent + PKCS11

on:
  workflow_dispatch:
    inputs:
      file_to_sign:
        description: "Path to file to sign"
        required: false
        default: "hello-world-app.exe"
  push:
    branches:
      - "main"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-22.04

    env:
      JSIGN_DEB_URL: "https://github.com/ebourg/jsign/releases/download/6.0/jsign_6.0_all.deb"
      KF_CFG_PATH: "/etc/keyfactor/config"
      PKCS11_PROVIDER_CFG: "keyfactorpkcs11.cfg"
      OUT_DIR: "signed-output"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      ############################################################
      # Validate required secrets
      ############################################################
      - name: Validate secrets
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          KF_AGENT_DEB_URL: ${{ secrets.KF_AGENT_DEB_URL }}
        run: |
          set -euo pipefail
          for s in SIGNUM_HOSTNAME SIGNUM_CLIENTID SIGNUM_USERNAME SIGNUM_PASSWORD KF_AGENT_DEB_URL; do
            if [ -z "${!s:-}" ]; then
              echo "Missing secret: $s"
              exit 1
            fi
          done
          echo "All required secrets are present."

      ############################################################
      # Install system dependencies (Ubuntu 22.04 safe)
      ############################################################
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            opensc \
            opensc-pkcs11 \
            pcscd \
            libpcsclite1 \
            libccid \
            p11-kit \
            gnutls-bin \
            default-jre-headless \
            curl \
            ca-certificates

      ############################################################
      # Install jsign
      ############################################################
      - name: Install jsign
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o jsign.deb "$JSIGN_DEB_URL"
          sudo dpkg -i jsign.deb || sudo apt-get -f install -y

      ############################################################
      # Install Keyfactor Agent
      ############################################################
      - name: Install Keyfactor Agent
        shell: bash
        env:
          KF_AGENT_DEB_URL: ${{ secrets.KF_AGENT_DEB_URL }}
        run: |
          set -euo pipefail
          curl -fsSL -o kf-agent.deb "$KF_AGENT_DEB_URL"
          sudo dpkg -i kf-agent.deb || sudo apt-get -f install -y

          sudo systemctl daemon-reload || true
          sudo systemctl enable KeyfactorService || true
          sudo systemctl restart KeyfactorService

      ############################################################
      # Configure Keyfactor Agent
      ############################################################
      - name: Configure Keyfactor Agent
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
        run: |
          set -euo pipefail

          echo -e "loglevel=HIGH\nlogtype=FILE" | sudo tee "$KF_CFG_PATH" > /dev/null

          sudo keyfactor-setup \
            hostname="$SIGNUM_HOSTNAME" \
            clientid="$SIGNUM_CLIENTID" \
            username="$SIGNUM_USERNAME" \
            password="$SIGNUM_PASSWORD"

          sudo systemctl restart KeyfactorService

      ############################################################
      # Locate PKCS11 module
      ############################################################
      - name: Locate PKCS11 module
        id: find_module
        shell: bash
        run: |
          set -euo pipefail

          MODULE_PATH=$(sudo find / -type f -name "libkeyfactorpkcs11.so" 2>/dev/null | head -n 1 || true)

          if [ -z "$MODULE_PATH" ]; then
            echo "PKCS11 module not found."
            exit 1
          fi

          echo "Found module at $MODULE_PATH"
          echo "module=$MODULE_PATH" >> $GITHUB_OUTPUT

      ############################################################
      # Write SunPKCS11 config
      ############################################################
      - name: Create PKCS11 provider config
        shell: bash
        run: |
          set -euo pipefail
          cat > "$PKCS11_PROVIDER_CFG" <<EOF
          name=Keyfactor
          library=${{ steps.find_module.outputs.module }}
          EOF

      ############################################################
      # Determine certificate alias
      ############################################################
      - name: Select certificate alias
        id: choose_cert
        shell: bash
        run: |
          set -euo pipefail

          FIRST_ID=$(keytool -list \
            -storetype PKCS11 \
            -providerClass sun.security.pkcs11.SunPKCS11 \
            -providerArg "$PKCS11_PROVIDER_CFG" \
            -storepass NONE 2>/dev/null \
            | grep -oE '^[0-9A-F]+' | head -n1 || true)

          if [ -z "$FIRST_ID" ]; then
            echo "No certificate found in PKCS11 store."
            exit 1
          fi

          echo "Selected alias: $FIRST_ID"
          echo "alias=$FIRST_ID" >> $GITHUB_OUTPUT

      ############################################################
      # Sign file
      ############################################################
      - name: Sign file with jsign
        shell: bash
        run: |
          set -euo pipefail

          FILE="${{ inputs.file_to_sign }}"
          if [ ! -f "$FILE" ]; then
            echo "File not found: $FILE"
            exit 1
          fi

          mkdir -p "$OUT_DIR"
          cp "$FILE" "$OUT_DIR/"

          jsign \
            --storetype PKCS11 \
            --keystore "$PKCS11_PROVIDER_CFG" \
            --storepass NONE \
            --alias "${{ steps.choose_cert.outputs.alias }}" \
            "$OUT_DIR/$(basename "$FILE")"

          echo "Signing completed."
          ls -la "$OUT_DIR"

      ############################################################
      # Upload artifact
      ############################################################
      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: signed-file
          path: signed-output/*
