name: Sign File via Signum Agent + Native PKCS11

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest

    env:
      SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      DOCKER_CONFIG: ${{ github.workspace }}/.docker
      FILES_DIR: filestosign
      PKCS11_LIB: /usr/lib/softhsm/libsofthsm2.so
      TOKEN_LABEL: GitHubToken
      TOKEN_PIN: 1234

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ============================================================
      # VALIDATE SIGNUM SECRETS
      # ============================================================

      - name: Validate Signum secrets
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          JFROG_DOCKER_AUTH: ${{ secrets.JFROG_DOCKER_AUTH }}
        run: |
          set -euo pipefail
          for s in SIGNUM_HOSTNAME SIGNUM_CLIENTID SIGNUM_USERNAME SIGNUM_PASSWORD JFROG_DOCKER_AUTH; do
            if [ -z "${!s:-}" ]; then
              echo "❌ Missing secret: $s"
              exit 1
            fi
          done
          echo "✅ All required secrets present."

      # ============================================================
      # INSTALL SOFTHSM2
      # ============================================================

      - name: Install SoftHSM2
        run: |
          sudo apt-get update
          sudo apt-get install -y softhsm2 opensc

      - name: Configure SoftHSM2
        run: |
          mkdir -p softhsm2-tokens
          cat > softhsm2.conf <<EOF
          directories.tokendir = $PWD/softhsm2-tokens
          objectstore.backend = file
          log.level = INFO
          EOF
          echo "SOFTHSM2_CONF=$PWD/softhsm2.conf" >> $GITHUB_ENV

      - name: Initialize PKCS11 token
        run: |
          softhsm2-util --init-token \
            --free \
            --label "$TOKEN_LABEL" \
            --so-pin "$TOKEN_PIN" \
            --pin "$TOKEN_PIN"

      - name: Generate PKCS11 keypair
        run: |
          pkcs11-tool \
            --module $PKCS11_LIB \
            --login \
            --pin "$TOKEN_PIN" \
            --keypairgen \
            --key-type rsa:2048 \
            --id 01 \
            --label github-key

      # ============================================================
      # CREATE FILE TO SIGN
      # ============================================================

      - name: Create file to sign
        run: |
          mkdir -p $FILES_DIR
          echo "Hello from Signum + native PKCS11 demo" > $FILES_DIR/file.txt

      # ============================================================
      # SIGN FILE USING PKCS11
      # ============================================================

      - name: Sign file with PKCS11 key
        run: |
          for f in $FILES_DIR/*.txt; do
            echo "Signing $f..."
            pkcs11-tool \
              --module $PKCS11_LIB \
              --login --pin "$TOKEN_PIN" \
              --sign \
              --id 01 \
              --input-file "$f" \
              --output-file "${f}.sig"
          done

      # ============================================================
      # UPLOAD SIGNED FILES AS ARTIFACT
      # ============================================================

      - name: Upload signed files
        uses: actions/upload-artifact@v3
        with:
          name: signed-files
          path: $FILES_DIR/*.sig
