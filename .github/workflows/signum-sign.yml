name: Sign document with Signum Container Agent (basic)

on:
  workflow_dispatch:
    inputs:
      signum_agent_image:
        description: "Container image to use (include tag)"
        required: false
        default: "keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1"

  push:
    branches: ["main"]
    paths:
      - "filestosign/**"
      - ".github/workflows/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest

    env:
      DEFAULT_SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      PKCS11_WORK_DIR: pkcs11-work
      PKCS11_WORK_MODULE: pkcs11-work/signum-pkcs11.so
      PKCS11_MOUNT_PATH: /pkcs11/signum-pkcs11.so
      DOCKER_CONFIG: ${{ github.workspace }}/.docker

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Support Notice
        run: |
          echo "## Signum Container Agent Usage" >> "$GITHUB_STEP_SUMMARY"
          echo "Support: https://support.keyfactor.com/" >> "$GITHUB_STEP_SUMMARY"

      # ============================================================
      # PREFLIGHT VALIDATION (ALL FROM SECRETS)
      # ============================================================

      - name: Validate required secrets
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_PKCS11_MODULE_B64: ${{ secrets.SIGNUM_PKCS11_MODULE_B64 }}
          JFROG_DOCKER_AUTH: ${{ secrets.JFROG_DOCKER_AUTH }}
        run: |
          set -euo pipefail

          echo "Running secret validation..."
          missing=()

          check_secret () {
            local name="$1"
            local value="$2"
            if [ -z "${value}" ]; then
              missing+=("$name")
            fi
          }

          check_secret "secrets.SIGNUM_HOSTNAME" "${SIGNUM_HOSTNAME}"
          check_secret "secrets.SIGNUM_CLIENTID" "${SIGNUM_CLIENTID}"
          check_secret "secrets.SIGNUM_USERNAME" "${SIGNUM_USERNAME}"
          check_secret "secrets.SIGNUM_PASSWORD" "${SIGNUM_PASSWORD}"
          check_secret "secrets.SIGNUM_PKCS11_MODULE_B64" "${SIGNUM_PKCS11_MODULE_B64}"
          check_secret "secrets.JFROG_DOCKER_AUTH" "${JFROG_DOCKER_AUTH}"

          if [ ${#missing[@]} -gt 0 ]; then
            echo "❌ Missing required secrets:" >> "$GITHUB_STEP_SUMMARY"
            for item in "${missing[@]}"; do
              echo "- $item" >> "$GITHUB_STEP_SUMMARY"
            done
            exit 1
          fi

          echo "✅ All required secrets are present." >> "$GITHUB_STEP_SUMMARY"

      # ============================================================
      # DOCKER AUTH (JFROG)
      # ============================================================

      - name: Configure Docker authentication
        shell: bash
        env:
          JFROG_DOCKER_AUTH: ${{ secrets.JFROG_DOCKER_AUTH }}
        run: |
          set -euo pipefail

          mkdir -p "$DOCKER_CONFIG"

          cat > "$DOCKER_CONFIG/config.json" <<EOF
          {
            "auths": {
              "keyfactor.jfrog.io": {
                "auth": "${JFROG_DOCKER_AUTH}"
              }
            }
          }
          EOF

          chmod 600 "$DOCKER_CONFIG/config.json"

          mkdir -p "$HOME/.docker"
          cp "$DOCKER_CONFIG/config.json" "$HOME/.docker/config.json"

          echo "Docker authentication configured."

      # ============================================================
      # RESOLVE IMAGE
      # ============================================================

      - name: Resolve agent image
        id: resolve_image
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="${{ inputs.signum_agent_image }}"
          if [ -z "${IMAGE}" ]; then
            IMAGE="${DEFAULT_SIGNUM_AGENT_IMAGE}"
          fi
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "Using image: ${IMAGE}"

      # ============================================================
      # RUN SIGNUM AGENT CONTAINER
      # ============================================================

      - name: Run Signum Agent and PKCS11 validation
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_AGENT_IMAGE: ${{ steps.resolve_image.outputs.image }}
          SIGNUM_PKCS11_MODULE_B64: ${{ secrets.SIGNUM_PKCS11_MODULE_B64 }}
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          set -euo pipefail

          echo "== System Info ==" | tee basic-checks.txt
          uname -a | tee -a basic-checks.txt
          docker --version | tee -a basic-checks.txt

          mkdir -p filestosign
          echo 'Write-Host "Hello from Signum signing demo"' > filestosign/example-script.ps1

          echo "== Pulling Signum Agent ==" | tee docker-pull.txt
          docker pull "${SIGNUM_AGENT_IMAGE}" 2>&1 | tee -a docker-pull.txt

          docker rm -f signum-agent >/dev/null 2>&1 || true

          echo "== Starting Signum Agent ==" | tee docker-run.txt
          docker run -d \
            --name signum-agent \
            -p 8080:8080 \
            -v "$PWD/filestosign:/mnt/filestosign" \
            -e SIGNUM_HOSTNAME \
            -e SIGNUM_CLIENTID \
            -e SIGNUM_USERNAME \
            -e SIGNUM_PASSWORD \
            "${SIGNUM_AGENT_IMAGE}" | tee -a docker-run.txt

          sleep 5
          docker ps | tee signum-container-status.txt

          # Prepare PKCS11 module
          mkdir -p "${PKCS11_WORK_DIR}"
          printf '%s' "${SIGNUM_PKCS11_MODULE_B64}" | base64 -d > "${PKCS11_WORK_MODULE}"
          chmod 755 "${PKCS11_WORK_MODULE}"

          echo "== PKCS11 Slot Listing ==" | tee pkcs11-slots.txt

          docker run --rm \
            -v "$PWD/${PKCS11_WORK_MODULE}:${PKCS11_MOUNT_PATH}:ro" \
            ghcr.io/open-sc/opensc:latest \
            pkcs11-tool --module "${PKCS11_MOUNT_PATH}" --list-slots \
            2>&1 | tee -a pkcs11-slots.txt || true

          docker logs signum-agent | tail -n 500 > signum-agent.log || true

      # ============================================================
      # CLEANUP
      # ============================================================

      - name: Cleanup container
        if: always()
        run: docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-output
          if-no-files-found: ignore
          path: |
            basic-checks.txt
            docker-pull.txt
            docker-run.txt
            signum-container-status.txt
            pkcs11-slots.txt
            signum-agent.log
            filestosign/example-script.ps1
            pkcs11-work/**
