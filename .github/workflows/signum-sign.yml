name: Sign document with Signum Container Agent (basic)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest

    env:
      SIGNUM_REGISTRY: repo.keyfactor.com
      SIGNUM_AGENT_IMAGE: repo.keyfactor.com/dev-oci/signum-agent:3.80.4-2024052902

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notes / Support Disclaimer
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Signum Container Agent with Signing Tools â€“ Support / Usage Notes
          Support issues: https://support.keyfactor.com/
          EOF

      - name: Docker login to JFrog Artifactory
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.JFROG_DOCKER_PASSWORD }}" | docker login "${SIGNUM_REGISTRY}" \
            -u "${{ secrets.JFROG_DOCKER_USERNAME }}" \
            --password-stdin

      - name: Pull + run Signum Agent container and list available certs
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
        run: |
          set -euo pipefail

          echo "== Basic checks =="
          echo "Runner: $(uname -a)"
          echo "Docker: $(docker --version)"

          echo "== Using image =="
          echo "${SIGNUM_AGENT_IMAGE}"

          echo "== Ensure there is something to sign =="
          mkdir -p filestosign
          if [ ! -f "filestosign/example-script.ps1" ]; then
            echo 'Write-Host "Hello from Signum signing demo"' > filestosign/example-script.ps1
          fi

          echo "== Pull Signum agent image =="
          docker pull "${SIGNUM_AGENT_IMAGE}"

          echo "== Run container =="
          docker run --name signum-agent -d \
            -v "$PWD/filestosign:/mnt/filestosign" \
            -e "SIGNUM_HOSTNAME=$SIGNUM_HOSTNAME" \
            -e "SIGNUM_CLIENTID=$SIGNUM_CLIENTID" \
            -e "SIGNUM_USERNAME=$SIGNUM_USERNAME" \
            -e "SIGNUM_PASSWORD=$SIGNUM_PASSWORD" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"

          echo "== Container status =="
          docker ps -a | sed -n '1,10p'

          echo "== List certs (signum-util lc) =="
          docker exec signum-agent signum-util lc | tee signum-certs.txt

          echo "### Signum cert listing (signum-util lc)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat signum-certs.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup container
        if: always()
        shell: bash
        run: |
          docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-output
          path: |
            signum-certs.txt
            filestosign/example-script.ps1
