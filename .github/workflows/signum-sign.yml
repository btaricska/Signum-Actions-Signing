#!/bin/bash
set -euo pipefail

# ============================================================
# Set Environment Variables
# ============================================================
SIGNUM_AGENT_IMAGE="keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1"
FILES_DIR="filestosign"
CONTAINER_NAME="signum-agent"
DOCKER_CONFIG="$PWD/.docker"
OPENSSL_MODULE_PATH="/usr/lib/libkeyfactorpkcs11.so"
CONTAINER_FILE="/mnt/$FILES_DIR/file.json"
CONTAINER_SIG="/mnt/$FILES_DIR/file.json.sig"
SO_PIN="admin123"     # Set your Security Officer PIN here
USER_PIN="foo1234"    # Set your User PIN here

# ============================================================
# Start Docker container with Signum Agent
# ============================================================
echo "‚úÖ Starting Signum Agent container..."
mkdir -p "$FILES_DIR"
docker pull $SIGNUM_AGENT_IMAGE
docker rm -f $CONTAINER_NAME >/dev/null 2>&1 || true

docker run -d \
  --name $CONTAINER_NAME \
  -v $PWD/$FILES_DIR:/mnt/$FILES_DIR \
  $SIGNUM_AGENT_IMAGE

echo "‚è≥ Waiting for PKCS11 module to become ready..."
for i in {1..30}; do
  if docker exec $CONTAINER_NAME pkcs11-tool --module $OPENSSL_MODULE_PATH --list-slots >/dev/null 2>&1; then
    echo "‚úÖ PKCS11 module is ready"
    break
  fi
  sleep 2
done
docker logs $CONTAINER_NAME | tail -n 20

# ============================================================
# Create JSON File to Sign
# ============================================================
echo "‚úÖ Creating JSON file to sign..."
mkdir -p "$FILES_DIR"
echo '{"message":"Hello from Signum + PKCS11 demo"}' > "$FILES_DIR/file.json"
echo "‚úÖ JSON file created"

# ============================================================
# Initialize Token if Not Already Initialized
# ============================================================
echo "üîç Verifying token initialization status..."
SLOT=$(docker exec $CONTAINER_NAME pkcs11-tool --module $OPENSSL_MODULE_PATH --list-slots \
        | awk '/Slot/ {slot=$2} /token flags:/ && /initialized/ {print slot; exit}')

if [ -z "$SLOT" ]; then
  echo "‚ùå No initialized token slot found"
  echo "üîë Initializing token slot with SO PIN '$SO_PIN' and user PIN '$USER_PIN'..."

  # Initialize the token slot
  docker exec $CONTAINER_NAME pkcs11-tool --module $OPENSSL_MODULE_PATH --slot 0 --init-token --so-pin "$SO_PIN" --pin "$USER_PIN" --label "Keyfactor for Linux" || { echo "‚ùå Token initialization failed"; exit 1; }

  echo "‚úÖ Token initialized successfully"
else
  echo "‚úÖ Token already initialized in slot $SLOT"
fi

# ============================================================
# List Available Slots and Private Keys
# ============================================================
echo "üîç Listing all available PKCS11 slots..."
docker exec $CONTAINER_NAME pkcs11-tool --module $OPENSSL_MODULE_PATH --list-slots

echo "üîë Listing private keys in slot $SLOT inside the container..."
KEY_INFO=$(docker exec $CONTAINER_NAME pkcs11-tool --module $OPENSSL_MODULE_PATH --slot "$SLOT" --login --list-objects --type privkey | head -n10)
if [ -z "$KEY_INFO" ]; then
  echo "‚ùå No private key found in slot $SLOT"
  exit 1
fi

KEY_ID=$(echo "$KEY_INFO" | awk '/ID:/ {print $2; exit}')
KEY_LABEL=$(echo "$KEY_INFO" | awk '/Label:/ {print $2; exit}')
echo "‚úÖ Found private key: ID = $KEY_ID, Label = $KEY_LABEL"

# ============================================================
# Sign the JSON File Using PKCS11
# ============================================================
echo "‚úçÔ∏è Signing JSON file inside the container..."
docker exec $CONTAINER_NAME pkcs11-tool --module $OPENSSL_MODULE_PATH --slot "$SLOT" --login --sign --input-file "$CONTAINER_FILE" --output-file "$CONTAINER_SIG" --id "$KEY_ID" || { echo "‚ùå Signing failed"; exit 1; }

# ============================================================
# Verify Signature File Creation
# ============================================================
docker exec $CONTAINER_NAME test -f "$CONTAINER_SIG" || { echo "‚ùå Signature file was not created"; exit 1; }

# ============================================================
# Copy the Signature File to the Host
# ============================================================
cp "$FILES_DIR/file.json.sig" .

echo "‚úÖ Signing completed successfully"

# ============================================================
# Upload the Signed File (Optional)
# ============================================================
# You can choose to upload the signature file as an artifact in your CI/CD workflow.
# For example:
# echo "‚úÖ Uploading the signature file..."
# actions/upload-artifact@v3
#   name: signed-file
#   path: file.json.sig
