name: PKCS11 Signing Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  signing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          sudo systemctl start docker

      - name: Pull Docker Image for Signum Agent
        run: docker pull keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1

      - name: Build and Run Docker Container
        run: |
          docker run -d --name signum-agent -v $(pwd)/filestosign:/mnt/filestosign keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1 /bin/bash -c "sleep 3600"

      - name: Set environment variables for file signing
        env:
          FILES_DIR: filestosign
          CONTAINER_NAME: signum-agent
        run: echo "‚úÖ Setting up environment variables for file signing..."

      - name: Execute signing script
        env:
          FILES_DIR: filestosign
          CONTAINER_NAME: signum-agent
        run: |
          set -euo pipefail

          MODULE="/usr/lib/libkeyfactorpkcs11.so"
          CONTAINER_FILE="/mnt/$FILES_DIR/file.json"
          CONTAINER_SIG="/mnt/$FILES_DIR/file.json.sig"
          SO_PIN="admin123"
          USER_PIN="foo123"

          # Step 1: Verify input file exists inside the container
          echo "‚úÖ Verifying input file exists inside the container..."
          docker exec $CONTAINER_NAME test -f "$CONTAINER_FILE" || { echo "‚ùå Input file not found inside container"; exit 1; }
          echo "‚úÖ Input file exists inside container"

          # Step 2: List all available PKCS11 slots inside the container
          echo "üîç Listing available PKCS11 slots inside the container..."
          docker exec $CONTAINER_NAME pkcs11-tool --module "$MODULE" --list-slots

          # Step 3: Check for private keys inside the container
          echo "üîë Listing private keys inside the container..."
          docker exec $CONTAINER_NAME pkcs11-tool --module "$MODULE" --list-objects --type privkey

          # Step 4: Extract the slot information and initialize if necessary
          SLOT=$(docker exec $CONTAINER_NAME pkcs11-tool --module "$MODULE" --list-slots | awk '/Slot/ {slot=$2} /token flags:/ && /initialized/ {print slot; exit}')
          if [ -z "$SLOT" ]; then
            echo "‚ùå No initialized token slot found in container"
            echo "üîë Initializing slot 0 with SO PIN '$SO_PIN' and user PIN '$USER_PIN'..."

            # Initialize the token if it's not already initialized
            docker exec $CONTAINER_NAME pkcs11-tool --module "$MODULE" --slot 0 --init-token --so-pin "$SO_PIN" --pin "$USER_PIN" --label "Keyfactor for Linux"

            # Check if initialization was successful
            SLOT=$(docker exec $CONTAINER_NAME pkcs11-tool --module "$MODULE" --list-slots | awk '/Slot/ {slot=$2} /token flags:/ && /initialized/ {print slot; exit}')
            if [ -z "$SLOT" ]; then
              echo "‚ùå Failed to initialize token in slot 0."
              exit 1
            fi

            echo "‚úÖ Slot 0 initialized successfully, now using slot $SLOT"
          else
            echo "‚úÖ Found initialized token in slot: $SLOT"
          fi

          # Step 5: List private keys after initialization
          echo "üîë Listing private keys in slot $SLOT inside the container..."
          KEY_INFO=$(docker exec $CONTAINER_NAME pkcs11-tool --module "$MODULE" --slot "$SLOT" --login --list-objects --type privkey | head -n10)
          if [ -z "$KEY_INFO" ]; then
            echo "‚ùå No private key found in container slot $SLOT"
            exit 1
          fi

          # Extract Key ID and Label
          KEY_ID=$(echo "$KEY_INFO" | awk '/ID:/ {print $2; exit}')
          KEY_LABEL=$(echo "$KEY_INFO" | awk '/Label:/ {print $2; exit}')
          echo "‚úÖ Using private key ID: $KEY_ID, Label: $KEY_LABEL"

          # Step 6: Sign the JSON file using the private key inside the container
          echo "‚úçÔ∏è Signing JSON file inside the container..."
          docker exec $CONTAINER_NAME pkcs11-tool --module "$MODULE" --slot "$SLOT" --login --sign --input-file "$CONTAINER_FILE" --output-file "$CONTAINER_SIG" --id "$KEY_ID"

          # Step 7: Verify signature file creation
          docker exec $CONTAINER_NAME test -f "$CONTAINER_SIG" || { echo "‚ùå Signature file was not created"; exit 1; }

          # Step 8: Copy signature file to runner workspace
          cp "$FILES_DIR/file.json.sig" .

          echo "‚úÖ Signing completed successfully"

      - name: Upload signature file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: signed-file
          path: file.json.sig
